<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commercial Building Survey</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 py-10">
    <div class="max-w-5xl mx-auto bg-white p-8 rounded-lg shadow">
        <h1 class="text-2xl font-bold text-center mb-8">COMMERCIAL BUILDING SURVEY</h1>

        <!-- Survey Form -->
        <form class="space-y-6" id="surveyForm">
            <!-- Address -->
            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Street Address</label>
                <textarea name="streetAddress" rows="3"
                    class="w-full border border-gray-300 px-4 py-2 rounded"></textarea>
            </div>
            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">City</label>
                <input type="text" name="city" class="w-full border border-gray-300 px-4 py-2 rounded" />
            </div>

            <!-- Map Link -->
            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Google Map Link</label>
                <input type="url" name="googleMapLink" class="w-full border border-gray-300 px-4 py-2 rounded" />
            </div>

            <!-- Building Name -->
            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Building Name (If Any)</label>
                <input type="text" name="buildingName" class="w-full border border-gray-300 px-4 py-2 rounded" />
            </div>

            <!-- POC Contact -->
            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Name & Contact Number of the POC</label>
                <textarea name="pointOfContact" rows="3"
                    class="w-full border border-gray-300 px-4 py-2 rounded"></textarea>
            </div>

            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Number of Floors(Including Ground Floor)</label>
                <input type="number" id="numberOfFloors" name="numberOfFloors"
                    class="w-full border border-gray-300 px-4 py-2 rounded">
            </div>

            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Floor Configuration</label>
                <input type="text" name="floorPattern" id="floorPattern"
                    class="w-full border border-gray-300 px-4 py-2 rounded" />
            </div>

            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Total Area of the Building</label>
                <input type="text" id="totalArea" name="totalArea"
                    class="w-full border border-gray-300 px-4 py-2 rounded">
            </div>

            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Quoted Efficiency of the Building(Super Builtup to Builtup
                    Area)</label>
                <input type="text" id="efficiency" name="efficiency"
                    class="w-full border border-gray-300 px-4 py-2 rounded">
            </div>

            <div class="max-w-md mx-auto">
                <label class="block font-semibold mb-1">Local Transport</label>
                <div class="border border-gray-300 rounded-md p-4 space-y-2 bg-gray-50">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="localTransport" value="Metro" class="accent-green-600">
                        <span>Metro</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="localTransport" value="E-Rickshaws" class="accent-green-600">
                        <span>E-Rickshaws</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="localTransport" value="Shared Autos" class="accent-green-600">
                        <span>Shared Autos</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="localTransport" value="Private Autos" class="accent-green-600">
                        <span>Private Autos</span>
                    </label>
                </div>
            </div>

            <!-- File Upload -->
            <div class="max-w-md mx-auto">
    <label class="block font-semibold mb-1">Upload Images</label>
    <input type="file" name="imageFiles" accept="image/*" multiple class="w-full border border-gray-300 px-4 py-2 rounded" />
</div>


            <!-- Floor Configuration Table -->
            <div class="max-w-7xl mx-auto mt-10">
                <h2 class="text-lg font-semibold mb-4">Floor Configuration and Status</h2>
                <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full text-sm text-gray-800" id="floorTable">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                            <tr>
                                <th class="px-4 py-3 border">Floor</th>
                                <th class="px-4 py-3 border">Unit 1 Super Area</th>
                                <th class="px-4 py-3 border">Unit 1 Carpet Area</th>
                                <th class="px-4 py-3 border">Status of Unit 1</th>
                                <th class="px-4 py-3 border">Rent Quoted (Unit 1)</th>
                                <th class="px-4 py-3 border">Client Name (Unit 1)</th>
                                <th class="px-4 py-3 border">Unit 2 Super Area</th>
                                <th class="px-4 py-3 border">Unit 2 Carpet Area</th>
                                <th class="px-4 py-3 border">Status of Unit 2</th>
                                <th class="px-4 py-3 border">Rent Quoted (Unit 2)</th>
                                <th class="px-4 py-3 border">Client Name (Unit 2)</th>
                                <th class="px-4 py-3 border">Unit 3 Super Area</th>
                                <th class="px-4 py-3 border">Unit 3 Carpet Area</th>
                                <th class="px-4 py-3 border">Status of Unit 3</th>
                                <th class="px-4 py-3 border">Rent Quoted (Unit 3)</th>
                                <th class="px-4 py-3 border">Client Name (Unit 3)</th>
                                <th class="px-4 py-3 border">Others</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                            <!-- Rows will be inserted here dynamically by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- Submit Buttons -->
            <div class="flex justify-center space-x-4 pt-4">
                <button type="submit"
                    class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">Submit</button>
            </div>
        </form>

        <!-- Search Section -->
        <div class="mt-12 p-6 bg-white border rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-6">Search Surveys</h2>

            <div class="mb-4">
                <label class="block text-lg font-medium">Search by Street Address</label>
                <div class="flex items-center mt-2">
                    <input type="text" id="searchInput" class="w-full p-2 border rounded-md"
                        placeholder="Enter street address" />
                    <button onclick="searchSurveys()"
                        class="ml-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Search
                    </button>
                </div>
            </div>

            <!-- Search Results Table -->
            <div id="searchResultsContainer" style="display: none;">
                <table class="w-full table-auto border-collapse mt-4">
                    <thead>
                        <tr class="bg-gray-100 text-left">
                            <th class="px-4 py-2 border">Street Address</th>
                            <th class="px-4 py-2 border">City</th>
                            <th class="px-4 py-2 border">Building Name</th>
                            <th class="px-4 py-2 border">Last Updated DateTime</th>
                            <th class="px-4 py-2 border">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be inserted here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Keep server awake
        function keepServerAwake() {
            fetch("https://surveyform-nbl0.onrender.com/keepalive")
                .then(() => console.log("Keep-alive ping sent"))
                .catch(() => console.log("Keep-alive ping failed"));
        }
        keepServerAwake();
        setInterval(keepServerAwake, 300000); // 5 minutes

        function getFloorSuffix(n) {
            if (n % 10 === 1 && n % 100 !== 11) return "st";
            if (n % 10 === 2 && n % 100 !== 12) return "nd";
            if (n % 10 === 3 && n % 100 !== 13) return "rd";
            return "th";
        }



        function generateRows() {
            const floorCount = parseInt(document.getElementById("numberOfFloors").value, 10) || 0;
            const floors = [
                "Basement",
                "Ground Floor",
                "Upper Ground Floor",
                ...Array.from({ length: floorCount }, (_, i) => {
                    const num = i + 1;
                    return `${num}${getFloorSuffix(num)} Floor`;
                })
            ];

            const tableBody = document.querySelector("#floorTable tbody");
            const rows = floors.map(floor => {
                return `
              <tr>
                <td class="px-4 py-2 border bg-gray-50 font-medium">${floor}</td>
                <td class="px-2 py-2 border"><input type="text" name="unit1SuperArea" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="unit1CarpetArea" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border">
                  <select name="unit1Status" class="w-full border rounded px-2 py-1">
                    <option>Bareshell</option>
                    <option>Warmshell</option>
                    <option>Fitted out</option>
                    <option>LL is ready to do Fitout</option>
                    <option>Occupied</option>
                  </select>
                </td>
                <td class="px-2 py-2 border"><input type="text" name="unit1RentQuoted" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="unit1ClientName" class="w-full border rounded px-2 py-1" /></td>       
                <td class="px-2 py-2 border"><input type="text" name="unit2SuperArea" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="unit2CarpetArea" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border">
                  <select name="unit2Status" class="w-full border rounded px-2 py-1">
                    <option>Bareshell</option>
                    <option>Warmshell</option>
                    <option>Fitted out</option>
                    <option>LL is ready to do Fitout</option>
                    <option>Occupied</option>
                  </select>
                </td>
                <td class="px-2 py-2 border"><input type="text" name="unit2RentQuoted" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="unit2ClientName" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="unit3SuperArea" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="unit3CarpetArea" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border">
                  <select name="unit3Status" class="w-full border rounded px-2 py-1">
                    <option>Bareshell</option>
                    <option>Warmshell</option>
                    <option>Fitted out</option>
                    <option>LL is ready to do Fitout</option>
                    <option>Occupied</option>
                  </select>
                </td>
                <td class="px-2 py-2 border"><input type="text" name="unit3RentQuoted" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="unit3ClientName" class="w-full border rounded px-2 py-1" /></td>
                <td class="px-2 py-2 border"><input type="text" name="others" class="w-full border rounded px-2 py-1" /></td>
              </tr>
            `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('surveyForm').reset();
            const floorInput = document.getElementById("numberOfFloors");
            if (floorInput) {
                floorInput.addEventListener("input", generateRows);
            }
            generateRows(); // Run initially if there's a default floor count
        });
        async function handleSubmit(event) {
            event.preventDefault();

            const localTransportCheckboxes = document.querySelectorAll("input[name='localTransport']:checked");
            console.log("floorPattern ", document.querySelector("input[name='floorPattern']"));
            const formData = {
                streetAddress: document.querySelector("textarea[name='streetAddress']").value,
                city: document.querySelector("input[name='city']").value,
                googleMapLink: document.querySelector("input[name='googleMapLink']").value,
                buildingName: document.querySelector("input[name='buildingName']").value,
                pointOfContact: document.querySelector("textarea[name='pointOfContact']").value,
                numberOfFloors: document.getElementById("numberOfFloors").value,
                totalArea: document.querySelector("input[name='totalArea']").value,
                efficiency: document.querySelector("input[name='efficiency']").value,
                localTransport: Array.from(localTransportCheckboxes).map(cb => cb.value),
                floorPattern: document.querySelector("input[name='floorPattern']").value,
                floorConfiguration: []
            };

            const floorRows = document.querySelectorAll("#floorTable tbody tr");
            floorRows.forEach(row => {
                const floorData = {
                    floor: row.cells[0].textContent.trim(),
                    unit1SuperArea: row.querySelector("input[name='unit1SuperArea']").value,
                    unit1CarpetArea: row.querySelector("input[name='unit1CarpetArea']").value,
                    unit1Status: row.querySelector("select[name='unit1Status']").value,
                    unit1RentQuoted: row.querySelector("input[name='unit1RentQuoted']").value,
                    unit1ClientName: row.querySelector("input[name='unit1ClientName']").value,

                    unit2SuperArea: row.querySelector("input[name='unit2SuperArea']").value,
                    unit2CarpetArea: row.querySelector("input[name='unit2CarpetArea']").value,
                    unit2Status: row.querySelector("select[name='unit2Status']").value,
                    unit2RentQuoted: row.querySelector("input[name='unit2RentQuoted']").value,
                    unit2ClientName: row.querySelector("input[name='unit2ClientName']").value,

                    unit3SuperArea: row.querySelector("input[name='unit3SuperArea']").value,
                    unit3CarpetArea: row.querySelector("input[name='unit3CarpetArea']").value,
                    unit3Status: row.querySelector("select[name='unit3Status']").value,
                    unit3RentQuoted: row.querySelector("input[name='unit3RentQuoted']").value,
                    unit3ClientName: row.querySelector("input[name='unit3ClientName']").value,

                    others: row.querySelector("input[name='others']").value
                };
                formData.floorConfiguration.push(floorData);
            });
            try {
                const response = await fetch("https://surveyform-nbl0.onrender.com/survey", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                } else {
                    alert(`Error: ${result.message}`);
                }
                window.location.reload();
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred while submitting the form.");
            }
            // Example: You can handle the data submission as per your requirements here (e.g., API call).
        }

        const form = document.getElementById('surveyForm'); // Replace with your actual form's ID
        form.addEventListener('submit', handleSubmit);

        // Block Enter from submitting form (except in textarea)
        form.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && event.target.type !== 'textarea') {
                event.preventDefault();
            }
        });
        // Simulating an API call with mock data
        async function searchSurveys() {
            const query = document.getElementById("searchInput").value.trim();
            if (!query) return;

            try {
                // Replace this with an actual API call like: 
                const response = await fetch(`https://surveyform-nbl0.onrender.com/survey/${query}`);
                const surveys = await response.json();
                const resultsTableBody = document.getElementById("resultsTableBody");
                resultsTableBody.innerHTML = '';  // Clear previous results

                // Loop through survey data and populate table
                surveys.forEach((survey, index) => {
                    const row = document.createElement("tr");
                    console.log(surveys[index]);
                    row.innerHTML = `
                        <td class="px-4 py-2 border">${survey.streetAddress}</td>
                        <td class="px-4 py-2 border">${survey.city}</td>
                        <td class="px-4 py-2 border">${survey.buildingName || 'N/A'}</td>
                        <td class="px-4 py-2 border">${timeConverted(survey.updatedAt) || 'N/A'}</td>
                        <td class="px-4 py-2 border">
                            <button onclick='editSurvey(${index})' class="bg-yellow-500 text-white px-4 py-2 rounded-md">Edit</button>
                        </td>
                    `;

                    resultsTableBody.appendChild(row);
                });

                // Display results table
                document.getElementById("searchResultsContainer").style.display = 'block';
            } catch (error) {
                console.error("Error fetching surveys:", error);
            }
        }
        function timeConverted(isoString) {
            const date = new Date(isoString);

            // Convert to IST and format
            const options = {
                timeZone: "Asia/Kolkata",
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true
            };

            const formatted = date.toLocaleString("en-IN", options);
            return formatted;
        }
        async function editSurvey(index) {
            const query = document.getElementById("searchInput").value.trim();
            const response = await fetch(`https://surveyform-nbl0.onrender.com/survey/${query}`);
            const surveys = await response.json();
            const survey = surveys[index];
            const resultsTableBody = document.getElementById("resultsTableBody");
            const row = resultsTableBody.rows[index];
            document.querySelector("textarea[name='streetAddress']").value = survey.streetAddress;
            document.querySelector("input[name='city']").value = survey.city;
            document.querySelector("input[name='googleMapLink']").value = survey.googleMapLink || '';
            document.querySelector("input[name='buildingName']").value = survey.buildingName || '';
            document.querySelector("textarea[name='pointOfContact']").value = survey.pointOfContact || '';
            document.querySelector("input[name='numberOfFloors']").value = survey.numberOfFloors || '';
            document.querySelector("input[name='totalArea']").value = survey.totalArea || '';
            document.querySelector("input[name='efficiency']").value = survey.efficiency || '';
            document.querySelector("input[name='floorPattern']").value = survey.floorPattern || '';
            generateRows();
            // Handling localTransport checkboxes
            const localTransportCheckboxes = document.querySelectorAll("input[name='localTransport']");
            localTransportCheckboxes.forEach(checkbox => {
                checkbox.checked = survey.localTransport && survey.localTransport.includes(checkbox.value);
            });

            // Handling Floor Configuration Table
            const floorConfiguration = survey.floorConfiguration || [];
            const floorTableBody = document.querySelector("#floorTable tbody");
            const floorRows = floorTableBody.querySelectorAll("tr");

            // Iterate through the floor configuration data and populate the table rows
            floorConfiguration.forEach((floorData, i) => {
                if (floorRows[i]) { // Ensure the row exists
                    const row = floorRows[i];
                    row.querySelector("input[name='unit1SuperArea']").value = floorData.unit1SuperArea || '';
                    row.querySelector("input[name='unit1CarpetArea']").value = floorData.unit1CarpetArea || '';
                    row.querySelector("select[name='unit1Status']").value = floorData.unit1Status || 'Bareshell';
                    row.querySelector("input[name='unit1RentQuoted']").value = floorData.unit1RentQuoted || '';
                    row.querySelector("input[name='unit1ClientName']").value = floorData.unit1ClientName || '';
                    row.querySelector("input[name='unit2SuperArea']").value = floorData.unit2SuperArea || '';
                    row.querySelector("input[name='unit2CarpetArea']").value = floorData.unit2CarpetArea || '';
                    row.querySelector("select[name='unit2Status']").value = floorData.unit2Status || 'Bareshell';
                    row.querySelector("input[name='unit2RentQuoted']").value = floorData.unit2RentQuoted || '';
                    row.querySelector("input[name='unit2ClientName']").value = floorData.unit2ClientName || '';
                    row.querySelector("input[name='unit3SuperArea']").value = floorData.unit3SuperArea || '';
                    row.querySelector("input[name='unit3CarpetArea']").value = floorData.unit3CarpetArea || '';
                    row.querySelector("select[name='unit3Status']").value = floorData.unit3Status || 'Bareshell';
                    row.querySelector("input[name='unit3RentQuoted']").value = floorData.unit3RentQuoted || '';
                    row.querySelector("input[name='unit3ClientName']").value = floorData.unit3ClientName || '';
                    row.querySelector("input[name='others']").value = floorData.others || '';
                }
            });

            // If the number of floors in the survey data is different from the current table rows,
            // you might need to regenerate the table rows based on survey.numberOfFloors
            const numberOfFloorsInput = document.getElementById("numberOfFloors");
            if (survey.numberOfFloors && parseInt(numberOfFloorsInput.value, 10) !== parseInt(survey.numberOfFloors, 10)) {
                numberOfFloorsInput.value = survey.numberOfFloors;
                generateRows(); // Regenerate the table with the correct number of rows
                // After regenerating, re-populate the data
                const newFloorRows = floorTableBody.querySelectorAll("tr");
                floorConfiguration.forEach((floorData, i) => {
                    if (newFloorRows[i]) {
                        const row = newFloorRows[i];
                        row.querySelector("input[name='unit1SuperArea']").value = floorData.unit1SuperArea || '';
                        row.querySelector("input[name='unit1CarpetArea']").value = floorData.unit1CarpetArea || '';
                        row.querySelector("select[name='unit1Status']").value = floorData.unit1Status || 'Bareshell';
                        row.querySelector("input[name='unit1RentQuoted']").value = floorData.unit1RentQuoted || '';
                        row.querySelector("input[name='unit1ClientName']").value = floorData.unit1ClientName || '';
                        row.querySelector("input[name='unit2SuperArea']").value = floorData.unit2SuperArea || '';
                        row.querySelector("input[name='unit2CarpetArea']").value = floorData.unit2CarpetArea || '';
                        row.querySelector("select[name='unit2Status']").value = floorData.unit2Status || 'Bareshell';
                        row.querySelector("input[name='unit2RentQuoted']").value = floorData.unit2RentQuoted || '';
                        row.querySelector("input[name='unit2ClientName']").value = floorData.unit2ClientName || '';
                        row.querySelector("input[name='unit3SuperArea']").value = floorData.unit3SuperArea || '';
                        row.querySelector("input[name='unit3CarpetArea']").value = floorData.unit3CarpetArea || '';
                        row.querySelector("select[name='unit3Status']").value = floorData.unit3Status || 'Bareshell';
                        row.querySelector("input[name='unit3RentQuoted']").value = floorData.unit3RentQuoted || '';
                        row.querySelector("input[name='unit3ClientName']").value = floorData.unit3ClientName || '';
                        row.querySelector("input[name='others']").value = floorData.others || '';
                    }
                });
            }
        }


        async function deleteSurveyByAddress(index) {
            const query = document.getElementById("searchInput").value.trim();
            const response = await fetch(`https://surveyform-nbl0.onrender.com/survey/${query}`);
            const surveys = await response.json();
            const survey = surveys[index];
            const streetAddress = survey.streetAddress;
            try {
              const response = await fetch(`https://surveyform-nbl0.onrender.com/survey/${streetAddress}`, {
                method: "DELETE"
              });
          
              const result = await response.json();
              if (response.ok) {
                alert(result.message);
              } else {
                alert(`Failed: ${result.message}`);
              }
              window.location.reload();
            } catch (error) {
              console.error("Delete request failed:", error);
              alert("An error occurred while deleting the survey.");
            }
          }
    </script>
</body>

</html>